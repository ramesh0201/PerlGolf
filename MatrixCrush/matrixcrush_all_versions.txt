1030
($a,$b,@d)=@ARGV;for$i(1..$a){for$j(1..$b){f($i,$j,$d[($i-1)*$b+$j-1],$i,$j,0)}}for$i(1..$a){for$j(1..$b){f($i,$j,$d[($i-1)*$b+$j-1],$i,$j,1,1,1,1,1)}}for$i(1..$a){for$j(1..$b){print$d[($i-1)*$b+$j-1]." ";$c+=$d[($i-1)*$b+$j-1]}print "\n"}print$c;sub f{my ($k,$l,$e,$g,$h,$m,$w,$x,$y,$z)=@_;if($k<$a){if($d[$k*$b+$l-1]==0&&$m&&$w){f($k+1,$l,$e,$g,$h,$m,1,0,0,0)}if($d[$k*$b+$l-1]==$e&&(!$m||($m&&$w))){$d[($g-1)*$b+$h-1]=0;$d[$k*$b+$l-1]=0;f($k+1,$l,$e,$k,$l,$m,1,1,1,1)}if($l>1&&$m&&$x&&$d[$k*$b+$l-2]==0){f($k+1,$l-1,$e,$g,$h,$m,0,1,0,0);}if($l>1&&$d[$k*$b+$l-2]==$e&&(!$m||($m&&$x))){$d[($g-1)*$b+$h-1]=0;$d[$k*$b+$l-2]=0;f($k+1,$l-1,$e,$k,$l,$m,1,1,1,1)}if($l<$b&&$m&&$y&&$d[$k*$b+$l]==0){f($k+1,$l+1,$e,$g,$h,$m,0,0,1,0)}if($l<$b&&$d[$k*$b+$l]==$e&&(!$m||($m&&$y))){$d[($g-1)*$b+$h-1]=0;$d[$k*$b+$l]=0;f($k+1,$l+1,$e,$k,$l,$m,1,1,1,1)}}if($l<$b){if($m&&$z&&$d[($k-1)*$b+$l]==0){f($k,$l+1,$e,$g,$h,$m,0,0,0,1)}if($d[($k-1)*$b+$l]==$e&&(!$m||($m&&$z))){$d[($g-1)*$b+$h-1]=0;$d[($k-1)*$b+$l]=0;f($k,$l+1,$e,$k,$l,$m,1,1,1,1)}}}

929
($a,$b,@d)=@ARGV;for$i(1..$a){for$j(1..$b){f($i,$j,$d[($i-1)*$b+$j-1],$i,$j)}}for$i(1..$a){for$j(1..$b){f($i,$j,$d[($i-1)*$b+$j-1],$i,$j,1,1,1,1,1)}}for$i(1..$a){for$j(1..$b){$f=($i-1)*$b+$j-1;print$d[$f]." ";$c+=$d[$f]}print$/}print$c;sub f{my($k,$l,$e,$g,$h,$m,$w,$x,$y,$z)=@_;$o=($g-1)*$b+$h-1;if($k<$a){my$r=$k*$b+$l;my$p=$r-1;my$q=$r-2;if(!$d[$p]&&$m&&$w){f($k+1,$l,$e,$g,$h,1,1,0,0,0)}if($d[$p]==$e&&(!$m||($m&&$w))){t($o,$p);f($k+1,$l,$e,$k,$l,$m,1,1,1,1)}if($l>1&&$m&&$x&&!$d[$q]){f($k+1,$l-1,$e,$g,$h,1,0,1,0,0);}if($l>1&&$d[$p-1]==$e&&(!$m||($m&&$x))){t($o,$q);f($k+1,$l-1,$e,$k,$l,$m,1,1,1,1)}if($l<$b&&$m&&$y&&!$d[$r]){f($k+1,$l+1,$e,$g,$h,1,0,0,1,0)}if($l<$b&&$d[$r]==$e&&(!$m||($m&&$y))){t($o,$r);f($k+1,$l+1,$e,$k,$l,$m,1,1,1,1)}}if($l<$b){$s=($k-1)*$b+$l;if($m&&$z&&!$d[$s]){f($k,$l+1,$e,$g,$h,1,0,0,0,1)}if($d[$s]==$e&&(!$m||($m&&$z))){t($o,$s);f($k,$l+1,$e,$k,$l,$m,1,1,1,1)}}}sub t{($u,$v)=@_;$d[$u]=$d[$v]=0}

510
($a,$b,@d,@c,@e)=@ARGV;for$i(1..$a){for$j(1..$b){$e[$i][$j]=$c[$i][$j]=$d[($i-1)*$b+$j-1]}}for$i(1..$a){for$j(1..$b){if("@{$e[$i-1]}[$j-1..$j+1]$e[$i][$j-1]$e[$i][$j+1]@{$e[$i+1]}[$j-1..$j+1]"=~/$e[$i][$j]/){$c[$i][$j]=0}}}@g=map{[@$_]}@c;sub z{($k,$l,$m,$n,$t)=@_;$u=$m;for$r($k..$l){for$s($m..$n){if($t){$s=--$u}$p=$g[$r][$s];$o=$g[$i][$j];if($p==$o){$c[$r][$s]=$c[$i][$j]=0}elsif($p&&$p!=$o){last}}}}for$i(1..$a){for$j(1..$b){z($i,$i,$j+1,$b);z($i+1,$a,$j,$j,1);$h+=$v=$c[$i][$j];print"$v "}print$/}print$h